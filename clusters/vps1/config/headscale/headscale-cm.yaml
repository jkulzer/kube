---
apiVersion: v1
kind: ConfigMap
metadata:
  name: headscale-config
  namespace: headscale
data:
  config.yaml: |-
    # server_url: https://vpn.jkulzer.dev
    server_url: https://vpn.jkulzer.dev

    listen_addr: 0.0.0.0:8080

    metrics_listen_addr: 0.0.0.0:9090

    grpc_listen_addr: 0.0.0.0:50443

    # Private key used to encrypt the traffic between headscale
    # and Tailscale clients.
    # The private key file will be autogenerated if it's missing.
    #
    private_key_path: /headscale/private.key

    # The Noise section includes specific configuration for the
    # TS2021 Noise protocol
    noise:
      # The Noise private key is used to encrypt the
      # traffic between headscale and Tailscale clients when
      # using the new Noise-based protocol. It must be different
      # from the legacy private key.
      private_key_path: /headscale/noise_private.key
    oidc:
      only_start_if_oidc_is_available: true
      #issuer: "https://auth.jkulzer.dev/.well-known/webfinger"
      issuer: "https://auth.jkulzer.dev"
      # Specified/generated by your OIDC provider
      client_id: "headscale"
      client_secret_path: "/secrets/HEADSCALE_OIDC_TOKEN"

      # Customize the scopes used in the OIDC flow, defaults to "openid", "profile" and "email" and add custom query
      # parameters to the Authorize Endpoint request. Scopes default to "openid", "profile" and "email".
      scope: ["openid", "profile", "email", "groups"]

      # Optional: List allowed principal domains and/or users. If an authenticated user's domain is not in this list,
      # the authentication request will be rejected.
      # Optional. Note that groups from Keycloak have a leading '/'.
      allowed_groups:
        - kubeadmin

      # If `strip_email_domain` is set to `true`, the domain part of the username email address will be removed.
      # This will transform `first-name.last-name@example.com` to the user `first-name.last-name`
      # If `strip_email_domain` is set to `false` the domain part will NOT be removed resulting to the following
      # user: `first-name.last-name.example.com`
      strip_email_domain: true

    # Any other range is NOT supported, and it will cause unexpected issues.
    ip_prefixes:
      - 100.64.0.0/10
      - fd7a:115c:a1e0::/48

    # DERP is a relay system that Tailscale uses when a direct
    # connection cannot be established.
    # https://tailscale.com/blog/how-tailscale-works/#encrypted-tcp-relays-derp
    #
    # headscale needs a list of DERP servers that can be presented
    # to the clients.
    derp:
      server:
        enabled: true
        # enabled: true
        region_id: 999
        region_code: "jkulzer.dev"
        region_name: "jkulzer.dev"
        stun_listen_addr: "0.0.0.0:3478"

    # Disables the automatic check for headscale updates on startup
    disable_check_updates: false

    # SQLite config
    db_type: sqlite3

    # For production:
    db_path: /headscale/db.sqlite

    # Domain name to request a TLS certificate for:
    tls_letsencrypt_hostname: ""

    log:
      # Output formatting for logs: text or json
      format: text
      level: info

    dns_config:
      # Whether to prefer using Headscale provided DNS or use local.
      override_local_dns: true

      # List of DNS servers to expose to clients.
      nameservers:
        - 1.1.1.1

      # Whether to use [MagicDNS](https://tailscale.com/kb/1081/magicdns/).
      # Only works if there is at least a nameserver defined.
      magic_dns: true
