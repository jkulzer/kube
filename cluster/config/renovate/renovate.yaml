---
apiVersion: v1
kind: Namespace
metadata:
  name: renovate
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: renovate
  namespace: renovate
spec:
  schedule: '@hourly'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: renovate
              volumeMounts:
                - mountPath: "/usr/local/share/ca-certificates/kube-home.crt"
                  name: public-key
                  subPath: "kube-home.crt"
                  readOnly: true
                - mountPath: "/etc/ssl/certs/kube-home.crt"
                  name: public-key
                  subPath: "kube-home.crt"
                  readOnly: true
                - name: config-volume
                  mountPath: "/usr/src/app/config.js"
                  subPath: "config.js"
                  readOnly: true
              image: renovate/renovate:31.14.0
              # command: 
              # - "/bin/bash /init/init.sh"
              # args:
              # - johannes/kube
              # Environment Variables
              env:
                - name: LOG_LEVEL
                  value: debug
                - name: NODE_EXTRA_CA_CERTS
                  value: /usr/local/share/ca-certificates/kube-cert.crt
          restartPolicy: Never
          volumes:
            - name: "public-key"
              configMap:
                name: wildcard-kube-home-distribution
            - name: config-volume
              configMap:
                name: renovate-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: renovate-config
data:
  config.js: |
    module.exports = {
      token: "<to be changed>",
      endpoint: 'http://gitea-http.gitea.svc.cluster.local:3000/api/v1/',
      repositories: ["johannes/kube"],
      platform: "gitea"
    };
